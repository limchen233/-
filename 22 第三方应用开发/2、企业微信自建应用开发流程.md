### **开发需知**

1、企业微信后台管理（不是小程序管理后台）：https://work.weixin.qq.com/wework_admin/loginpage_wx?from=myhome

2、企业微信开发者文档（不是小程序文档）：https://developer.work.weixin.qq.com/document/path/90556

3、开发应用的类型：根据开发应用类型选择文档

![image-20230822161613634](https://raw.githubusercontent.com/limchen233/picgo/master/img/image-20230822161613634.png)

4、文档中有`服务端API`和`客户端API`，根据需要查看对应的`API`说明。一般授权相关的在`服务端API`，相询基础信息、客户信息、联系人等在`客户端API`。

5、开发需知：https://developer.work.weixin.qq.com/document/path/90665，https://developer.work.weixin.qq.com/document/path/91039

6、创建企业内部应用的步骤：https://developer.work.weixin.qq.com/tutorial/detail/45

### **构造访问链接**

1、在自建应用里找到创建的应用，点击应用进入应用详情，能看到`AgentId`,`Secret`等信息。

2、设置应用主页，如下图：

![image-20230823114419716](https://raw.githubusercontent.com/limchen233/picgo/master/img/image-20230823114419716.png)

这个主页就是我们要访问的应用首页地址。格式：`https://open.weixin.qq.com/connect/oauth2/authorize?appid=CORPID&redirect_uri=REDIRECT_URI&response_type=code&scope=snsapi_base&state=STATE&agentid=AGENTID#wechat_redirect`

**参数说明：**

| 参数               | 必须 | 说明                                                         |
| :----------------- | :--: | :----------------------------------------------------------- |
| `appid`            |  是  | 企业的`CorpID`                                               |
| `redirect_uri`     |  是  | 授权后重定向的回调链接地址，（即我们创建的应用首页的访问地址，需用域名）**请使用`urlencode`对链接进行处理** |
| `response_type`    |  是  | 返回类型，此时固定为：code                                   |
| `scope`            |  是  | 应用授权作用域。 `snsapi_base`：[静默授权](https://developer.work.weixin.qq.com/document/path/91022#15019/静默授权与手动授权)，可获取成员的基础信息（`UserId`与`DeviceId`）； `snsapi_privateinfo`：[手动授权](https://developer.work.weixin.qq.com/document/path/91022#15019/静默授权与手动授权)，可获取成员的详细信息，包含头像、二维码等敏感信息。 |
| `state`            |  否  | 重定向后会带上state参数，企业可以填写`a-zA-Z0-9`的参数值，长度不可超过128个字节 |
| `agentid`          |  是  | 应用`agentid`，**建议填上该参数**（对于第三方应用和代开发自建应用，在填写该参数的情况下或者在工作台、聊天工具栏、应用会话内发起`oauth2`请求的场景中，会触发接口许可的自动激活）。`snsapi_privateinfo`时必填否则报错； |
| `#wechat_redirect` |  是  | 终端使用此参数判断是否需要带上身份信息                       |

员工点击后，页面将跳转至 `redirect_uri?code=CODE&state=STATE`，企业可根据code参数获得员工的`userid`。code长度最大为512字节。

详细介绍：https://developer.work.weixin.qq.com/document/path/91022

> 注意事项：
>
> 1、链接中`appid`前面是固定的，`https://open.weixin.qq.com/connect/oauth2/authorize?`
>
> 2、`redirect_uri`的值就是我们应用的访问地址，并且要用域名访问。需要转码。
>
> 3、在线转码工具：http://www.jsons.cn/urlencode/

例如，应用的主页地址为：

`https://open.weixin.qq.com/connect/oauth2/authorize?appid=ww123456&redirect_uri=https://test.com.cn/#/test/index&response_type=code&scope=snsapi_privateinfo&state=wechat&agentid=10000#wechat_redirect`

用上面的转码工具转码后的地址为：

`https%3A%2F%2Fopen.weixin.qq.com%2Fconnect%2Foauth2%2Fauthorize%3Fappid%3Dww123456%26redirect_uri%3Dhttps%3A%2F%2Ftest.com.cn%2F%23%2Ftest%2Findex%26response_type%3Dcode%26scope%3Dsnsapi_privateinfo%26state%3Dwechat%26agentid%3D10000%23wechat_redirect`

**此转码后的地址即为应用主页地址。**

> 注意：
>
> 1、应用主页只能填写一个地址，所以为了区分测试和生产环境，要创建两个应用。**两个应用有两个不同的应用id和应用secret**。在注入应用权限时要区分应用id。
>
> 2、获取access_token是调用企业微信`API`接口的第一步，相当于创建了一个登录凭证，其它的业务`API`接口，都需要依赖于access_token来鉴权调用者身份。因此开发者，在使用业务接口前，要明确access_token的颁发来源，使用正确的access_token。每个应用有独立的secret，获取到的access_token只能本应用使用，所以每个应用的access_token应该分开来获取。所以要把两个应用的secret都要提供给后台（access_token是后台获取的，需要企业id和应用secret）。

### 设置网页授权及`JS-SDK`

企业微信`JS-SDK`是企业微信面向网页开发者提供的基于企业微信内的网页开发工具包。

通过使用企业微信`JS-SDK`，网页开发者可借助企业微信高效地使用拍照、选图、语音、位置等手机系统的能力，同时可以直接使用企业微信分享、扫一扫等企业微信特有的能力，为企业微信用户提供更优质的网页体验。

> 注意：所有的JS接口只能在企业微信应用的可信域名下调用(包括子域名)，且可信域名必须有`ICP`备案且在管理端验证域名归属。
> 验证域名归属的方法在企业微信的管理后台“我的应用”里，进入应用，设置应用可信域名。



点击网页授权及`JS-SDK`，

![image-20230823143612962](https://raw.githubusercontent.com/limchen233/picgo/master/img/image-20230823143612962.png)

可信域名就是上面链接中的域名：`test.com.cn`

域名填写完后还要进行认证。点`申请校验域名`，会出现下载的文件，将文件下载下来给后端，存放到域名根目录下就行了。

### `JS-SDK`使用说明

1、引入`JS`文件

在需要调用接口的页面引入如下`JS`文件

```js
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js" referrerpolicy="origin"></script>
<script src="https://open.work.weixin.qq.com/wwopen/js/jwxwork-1.0.0.js" referrerpolicy="origin"></script> // 通过agentConfig注入应用的权限需要此js
```

2、通过`config`接口注入权限验证配置

> ![img](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHJ4PSI4IiBmaWxsPSIjQjM2NzFEIi8+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik04IDNDNy40NDc3MiAzIDcgMy40NDc3MiA3IDRWOEM3IDguNTUyMjggNy40NDc3MiA5IDggOUM4LjU1MjI4IDkgOSA4LjU1MjI4IDkgOFY0QzkgMy40NDc3MiA4LjU1MjI4IDMgOCAzWk04IDExQzcuNDQ3NzIgMTEgNyAxMS40NDc3IDcgMTJDNyAxMi41NTIzIDcuNDQ3NzIgMTMgOCAxM0M4LjU1MjI4IDEzIDkgMTIuNTUyMyA5IDEyQzkgMTEuNDQ3NyA4LjU1MjI4IDExIDggMTFaIiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==)注意
>
> 所有需要使用`JS-SDK`的页面必须先注入配置信息，否则将无法调用（同一个`url`仅需调用一次，对于变化`url`的SPA（single-page application）的`web app`可在每次`url`变化时进行调用）。

```js
// 注入企业的身份与权限
wx.config({
    beta: true,// 必须这么写，否则wx.invoke调用形式的jsapi会有问题
    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    appId: '', // 必填，企业微信的corpID，必须是本企业的corpID，不允许跨企业使用
    timestamp: '', // 必填，生成签名的时间戳
    nonceStr: '', // 必填，生成签名的随机串
    signature: '',// 必填，签名，见 附录-JS-SDK使用权限签名算法
    jsApiList: [] // 必填，需要使用的JS接口列表，凡是要调用的接口都需要传进来
});
```

3、通过ready接口处理成功验证

```js
wx.ready(function(){
    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
    
    // 注入应用的身份与权限
    wx.agentConfig({
        corpid: '', // 必填，企业微信的corpid，必须与当前登录的企业一致
        agentid: '', // 必填，企业微信的应用id （e.g. 1000247）
        timestamp: , // 必填，生成签名的时间戳
        nonceStr: '', // 必填，生成签名的随机串
        signature: '',// 必填，签名，见附录-JS-SDK使用权限签名算法
        jsApiList: ['selectExternalContact'], //必填，传入需要使用的接口名称
        success: function(res) {
            // 回调
        },
        fail: function(res) {
            if(res.errMsg.indexOf('function not exist') > -1){
                alert('版本过低请升级')
            }
        }
    });
});

```

> agentConfig的作用
> `config`注入的是企业的身份与权限，而`agentConfig`注入的是应用的身份与权限。尤其是当调用者为第三方服务商时，通过`config`无法准确区分出调用者是哪个第三方应用，而在部分场景下，又必须严谨区分出第三方应用的身份，此时即需要通过`agentConfig`来注入应用的身份信息。
>
> 具体请查阅：https://developer.work.weixin.qq.com/document/path/94313

4、通过error接口处理失败验证

```js
wx.error(function(res){
    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});
```



事例：

```js
// 企业微信
const timeStapm = Date.now()
const noncestr = 'qwert123'
const url = window.location.href.split('#')[0]

getJsapiTicket().then(res => {// 后端封装的接口，获取企业凭证
    getApplicationJsapiTicket().then(ress => { // 后端封装的接口，获取应用凭证
        const params = {
            jsapiTicket: res.data.ticket,
            noncestr: noncestr,
            timestamp: timeStapm,
            url: url
        }
          const params1 = {
            jsapiTicket: ress.data.ticket,
            noncestr: noncestr,
            timestamp: timeStapm,
            url: url
          }
          getJsSdkSign(params).then(sdk1 => {// 后端封装的接口，通过凭证获取签名
            getJsSdkSign(params1).then(sdk2 => {
              // 注入企业的身份与权限
              window.wx.config({
                beta: true, // 必须这么写，否则wx.invoke调用形式的jsapi会有问题
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: 'wwc123456', // 必填，企业微信的corpID
                timestamp: timeStapm, // 必填，生成签名的时间戳
                nonceStr: noncestr, // 必填，生成签名的随机串
                signature: sdk1.data, // 必填，签名，见 附录-JS-SDK使用权限签名算法
                jsApiList: ['getCurExternalContact', 'getContext'] // 必填，需要使用的JS接口列表，凡是要调用的接口都需要传进来
              })
              window.wx.ready(() => {
                // 注入应用的身份与权限
                window.wx.agentConfig({
                  corpid: 'wwc123456', // 必填，企业微信的corpid，必须与当前登录的企业一致
                  agentid: process.env.NODE_ENV === 'production' ? '应用生产id' : '应用测试id', // 必填，企业微信的应用id（生产和测试要分别创建应用）
                  timestamp: timeStapm, // 必填，生成签名的时间戳
                  nonceStr: noncestr, // 必填，生成签名的随机串
                  signature: sdk2.data, // 必填，签名，见附录-JS-SDK使用权限签名算法
                  jsApiList: ['getCurExternalContact', 'getContext'], // 必填，传入需要使用的接口名称
                  success: data => {
                    // 回调
                    window.wx.checkJsApi({
                      jsApiList: ['getCurExternalContact', 'getContext'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
                      success: data1 => {
                        // 以键值对的形式返回，可用的api值true，不可用为false
                        // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
                        console.log('checkJsApi检测可用接口', data1)
                      },
                      fail: fail => {
                        console.log('checkJsApi', fail)
                      }
                    })
                    window.wx.invoke('getContext', {}, data2 => {
                      if (data2.err_msg == 'getContext:ok') {
                        const entry = data2.entry // 返回进入H5页面的入口类型，目前有normal、contact_profile、single_chat_tools、group_chat_tools、chat_attachment
                        // const shareTicket = data2.shareTicket // 可用于调用getShareInfo接口
                        console.log(entry)
                      } else {
                        // 错误处理
                      }
                    })
                    window.wx.invoke(
                      'getCurExternalContact',
                      {
                        filterType: 0 // 0表示展示全部外部联系人列表，1表示仅展示未曾选择过的外部联系人。默认值为0；除了0与1，其他值非法。在企业微信2.4.22及以后版本支持该参数
                      },
                      invoke => {
                        console.log('invoke:', invoke)
                        if (invoke.err_msg == 'getCurExternalContact:ok') {
                          const userId = invoke.userId // 返回此次选择的外部联系人userId列表，数组类型
                          this.visitorPhone = userId
                          localStorage.setItem('wechatuserId', userId)
                          this.getBasicSearchRelation()
                        } else {
                          console.log('invoke error:', invoke)
                          // 错误处理
                        }
                      }
                    )
                  },
                  fail: fail => {
                    console.log(444444, fail)
                    if (fail.errMsg.indexOf('function not exist') > -1) {
                      alert('版本过低请升级')
                    }
                  }
                })
              })
              window.wx.error(err => {
                console.log(222222222, err)
              })
            })
          })
        })
      })
```

### 配置企业可信`IP`

**这一步很重要，否则会出现微信`API`不能调用!!!**

在应用详情，开发者接口--企业可信`IP`。可信`IP`是项目服务器的`ip`，直接让后台提供就行。不要忘记加上本地的`IP`。多个用`;`分隔。



![image-20230823194812732](https://raw.githubusercontent.com/limchen233/picgo/master/img/image-20230823194812732.png)
